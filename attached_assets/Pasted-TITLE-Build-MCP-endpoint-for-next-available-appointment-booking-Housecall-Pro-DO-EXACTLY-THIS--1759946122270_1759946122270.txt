TITLE: Build MCP endpoint for next available appointment + booking (Housecall Pro)

DO EXACTLY THIS, NO DETOURS:

Project Setup

Create a new FastAPI app (Python 3.11) in /app.

Use uvicorn to run: uvicorn app.main:app --host 0.0.0.0 --port 8000.

Add a Dockerfile and requirements.txt with: fastapi, uvicorn[standard], pydantic, httpx, python-dateutil, playwright (install chromium), tenacity (retry).

Expose port 8000.

Config

Read env vars:

HCP_PUBLIC_BOOKING_URL (the public Housecall Pro online booking URL for Johnson Bros).

HCP_SERVICE_SLUG_DEFAULT (fallback service slug, e.g. drain-cleaning).

MCP_AUTH_TOKEN (shared secret for write actions).

Fail fast at startup if HCP_PUBLIC_BOOKING_URL is missing.

MCP Contract (HTTP)
Implement three endpoints under /mcp:

a) GET /mcp/tools
Returns JSON:

{
  "tools": [
    {
      "name": "next_available_appointment",
      "description": "Return the earliest available slot from Housecall Pro.",
      "input_schema": {
        "type": "object",
        "properties": {
          "service": {"type": "string"},
          "zip": {"type": "string"},
          "urgency": {"type": "string", "enum": ["routine","soon","emergency"]}
        }
      }
    },
    {
      "name": "book_appointment",
      "description": "Book a specific slot for a customer.",
      "input_schema": {
        "type": "object",
        "properties": {
          "slot_id": {"type": "string"},
          "first_name": {"type": "string"},
          "last_name": {"type": "string"},
          "phone": {"type": "string"},
          "email": {"type": "string"},
          "address": {"type": "string"},
          "notes": {"type": "string"}
        },
        "required": ["slot_id","first_name","last_name","phone","address"]
      },
      "auth": "bearer"
    },
    {
      "name": "healthcheck",
      "description": "Simple readiness probe",
      "input_schema": {"type": "object","properties": {}}
    }
  ]
}


b) POST /mcp/call/next_available_appointment
Input: { "service"?: string, "zip"?: string, "urgency"?: "routine|soon|emergency" }
Output (200):

{
  "slot_id": "string",
  "start": "ISO8601",
  "end": "ISO8601",
  "technician": "string|null",
  "service": "string",
  "raw": { "provider_payload": {} }
}


c) POST /mcp/call/book_appointment (requires header Authorization: Bearer ${MCP_AUTH_TOKEN})
Input: as schema above.
Output (200):

{ "status": "confirmed", "appointment_id": "string", "start": "ISO8601", "end": "ISO8601" }


d) GET /mcp/healthz → { "ok": true }

Housecall Pro Integration

First try to call Housecall Pro’s public booking data behind HCP_PUBLIC_BOOKING_URL. Many installs expose JSON/XHR endpoints once the widget loads.

Strategy:

Attempt non-headless fetch of predictable JSON endpoints (common patterns: service availability or calendar availability used by the widget).

If not directly accessible, use Playwright (Chromium) to render the booking page headlessly, select service (use provided or default), and extract the earliest slot from the calendar. Time out at 10s, retry up to 3 times with exponential backoff.

Parse timezone correctly and return ISO8601 with timezone offset.

Infer technician if the DOM exposes it; else return null.

For book_appointment, submit the same form flow the widget uses (XHR or DOM) with the provided customer details. Return appointment_id from the response. If a programmatic booking endpoint is unavailable, perform the DOM submission headlessly and parse the confirmation page/id.

Server-Side “First Open Slot” snippet

Add GET /first-open-slot.json that calls next_available_appointment internally and returns:

{ "start": "ISO8601", "end": "ISO8601", "human": "Wed Oct 8, 10:30 AM–12:30 PM" }


This endpoint must not require auth.

Security & Resilience

Rate-limit /mcp/* to 30 rpm by IP. Reject if over.

Validate inputs with Pydantic. Sanitize strings.

Add health/readiness: /mcp/healthz and root /healthz.

Log errors with redaction (phones/emails).

Tests (must pass)

Unit test next_available_appointment with mocked XHR JSON and with Playwright DOM.

Unit test book_appointment happy path (mock) and failure path (slot no longer available).

Smoke test for /first-open-slot.json.

Deploy

Start the app at / with a simple JSON { "service": "Johnson Bros MCP" }.

Ensure the app runs on Replit and exposes a public URL.

Output the public base URL at the end (e.g., https://<repl>.replit.app).

WWW → Apex Redirect (note for infra)

If this app fronts the website, implement a middleware:

If host starts with www., 301 to apex.

Otherwise, provide an NGINX snippet for us to apply at the edge:

server {
  listen 80;
  server_name www.theabingtonplumber.com;
  return 301 https://theabingtonplumber.com$request_uri;
}


Acceptance Criteria (do not mark done unless all pass)

GET /mcp/tools returns the three tools above.

POST /mcp/call/next_available_appointment returns a slot within 2 seconds when the JSON endpoint is available; ≤12 seconds when Playwright fallback is used.

POST /mcp/call/book_appointment books and returns a confirmation id using Authorization: Bearer ${MCP_AUTH_TOKEN}.

GET /first-open-slot.json returns a humanized string and valid ISO datetimes.

Rate limiting and healthz working.

Provide a short README with:

Env vars

How to run Playwright install: playwright install --with-deps chromium

Example cURL calls (below)

Example cURL

# tools
curl -s https://<repl>.replit.app/mcp/tools

# next available
curl -s -X POST https://<repl>.replit.app/mcp/call/next_available_appointment \
  -H 'Content-Type: application/json' \
  -d '{"service":"drain-cleaning","zip":"02169","urgency":"soon"}'

# book slot
curl -s -X POST https://<repl>.replit.app/mcp/call/book_appointment \
  -H 'Authorization: Bearer '"$MCP_AUTH_TOKEN" \
  -H 'Content-Type: application/json' \
  -d '{
    "slot_id":"SLOT123",
    "first_name":"Nate","last_name":"Johnson",
    "phone":"617-555-1212","email":"dispatch@theabingtonplumber.com",
    "address":"55 Brighton St, Abington, MA",
    "notes":"Main line backup, basement cleanout access."
  }'


Code Skeleton (placeholders ok; fill details):

app/main.py: FastAPI app + routes

app/hcp.py: availability + booking logic (XHR then Playwright fallback)

app/models.py: Pydantic schemas

tests/test_hcp.py: tests

requirements.txt, Dockerfile, README.md

Finish by replying with:

Public base URL

Example outputs from /mcp/tools, next_available_appointment, and /first-open-slot.json

Any setup notes we must do in DNS/edge