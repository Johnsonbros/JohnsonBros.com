F) Actions / integrations (REAL via MCP server)

We will implement REAL actions behind cards using our MCP server as the execution layer. The website (client + server) must NOT call Housecall Pro directly. It must call MCP tools. All UI actions must route through a centralized dispatcher. Components never contain integration logic.

GOAL
- ChatKit stays intact.
- Cards trigger real actions (booking, estimate request, availability lookup) by calling MCP tools.
- MCP is the single integration surface for Housecall Pro (and future SMS/voice/CRM actions).
- We log every action request + outcome.

HIGH-LEVEL FLOW
1) User clicks a card CTA (e.g., “Book Now”).
2) Client calls `dispatchCardAction(action, payload, context)`.
3) Client POSTs to server: `POST /api/actions/dispatch`
4) Server:
   - validates payload (Zod)
   - enriches context (threadId, sessionId, ip, user agent)
   - calls MCP tool(s)
   - logs request + response (redacted)
   - returns a structured result, optionally including a new CardIntent (e.g., booking confirmation card).
5) Client:
   - shows toast + renders returned confirmation/follow-up card
   - if missing fields, opens booking modal to collect required info

NON-NEGOTIABLE CONSTRAINTS
- Centralized action logic only: all actions go through `/api/actions/dispatch`.
- No model-provided HTML. No arbitrary URLs from the model.
- Only allow a whitelisted action enum + Zod-validated payload shapes.
- Server re-validates payload; client validation is not sufficient.
- All MCP calls happen server-side (secrets remain server-side).
- Streaming chat stays separate: action execution is event-driven via user clicks, not auto-triggered by the model.

ACTION TYPES (V1)
- HOUSECALL_PRO_BOOKING
- HOUSECALL_PRO_ESTIMATE_REQUEST
- HOUSECALL_PRO_AVAILABILITY_LOOKUP (optional but recommended)
- INTERNAL_BOOKING_FLOW (our guided UX steps that ultimately call HCP actions)

ACTION PAYLOAD SCHEMAS (define in `actionSchemas.ts`)
Use Zod schemas and a discriminated union:

Example payload shape for HOUSECALL_PRO_BOOKING:
{
  "threadId": string,
  "serviceId": string,                 // our internal service id
  "customer": {
    "firstName": string,
    "lastName": string,
    "phone": string,
    "email"?: string
  },
  "address": {
    "line1": string,
    "line2"?: string,
    "city": string,
    "state": string,
    "zip": string
  },
  "preferred": {
    "date1"?: "YYYY-MM-DD",
    "date2"?: "YYYY-MM-DD",
    "timeWindow"?: "AM" | "PM" | "EVENING"
  },
  "notes"?: string,
  "marketing"?: { "source"?: string, "campaign"?: string }
}

HOUSECALL_PRO_ESTIMATE_REQUEST:
{
  "threadId": string,
  "serviceId": string,
  "customer": { ...same... },
  "address": { ...same... },
  "problemSummary": string,
  "photos"?: Array<{ "assetId": string }>    // IMPORTANT: must be OUR uploaded assets, not external URLs
}

SERVICE ID MAPPING
- Maintain a mapping table/config from our `serviceId` -> Housecall Pro identifier expected by MCP tool.
- This mapping lives server-side (DB preferred; config file acceptable for V1).
- The client never sees Housecall Pro IDs.

MCP CLIENT MODULE (server-side)
Create `mcpClient.ts` (or reuse existing):
- Responsible for calling MCP server tools.
- MUST support:
  - tool invocation with name + args
  - request id / correlation id
  - timeout + retry policy (lightweight)
- Example interface:
  - `invokeTool(toolName: string, args: object): Promise<{ ok: boolean, data?: any, error?: any }>`
- MCP server base URL + auth in env vars only.

SERVER DISPATCH ENDPOINT
Create: `POST /api/actions/dispatch`

Request:
{
  "action": "HOUSECALL_PRO_BOOKING" | ...,
  "payload": unknown,
  "context": { "threadId": string, "sessionId"?: string }
}

Server behavior:
1) Validate action + payload with Zod.
2) Normalize/clean phone, address fields if needed.
3) Resolve service mapping.
4) Call MCP tool(s) based on action:
   - HOUSECALL_PRO_AVAILABILITY_LOOKUP:
       tool: `housecall_pro.get_availability`
       args: { serviceHcpId, zip, preferredDates }
   - HOUSECALL_PRO_BOOKING:
       tool: `housecall_pro.create_booking` (or `create_job`, `create_appointment_request` depending on MCP toolset)
       args: { serviceHcpId, customer, address, preferred, notes, marketing }
   - HOUSECALL_PRO_ESTIMATE_REQUEST:
       tool: `housecall_pro.create_estimate_request`
       args: { serviceHcpId, customer, address, problemSummary, photosAssetIds }
5) Write an action log record (with PII redaction):
   - id, threadId, action, payloadRedacted, status, mcpTool, externalId, createdAt, correlationId
6) Return structured response:
{
  "ok": boolean,
  "action": string,
  "correlationId": string,
  "result"?: {
    "message": string,
    "externalId"?: string,
    "card"?: CardIntent
  },
  "error"?: { "code": string, "details"?: string, "missingFields"?: string[] }
}

MISSING FIELDS HANDLING (REAL UX)
- If required fields are missing:
  - Server returns ok:false, code:"MISSING_FIELDS", missingFields:[...]
  - Client opens internal booking modal to collect missing fields
  - On submit, client calls dispatch again with completed payload
- Do NOT let the model decide required fields. Server schema decides.

CLIENT DISPATCHER (real)
Create `dispatchCardAction.ts` (client):
- Sends POST to `/api/actions/dispatch`
- Handles:
  - ok:true => toast + add returned card to card store
  - MISSING_FIELDS => open booking modal + prefill known fields
  - errors => show fallback card with call-in CTA + contact form link

FALLBACKS
- If MCP or HCP fails:
  - ok:false with code "INTEGRATION_DOWN"
  - Client renders fallback card:
    title: "We can book you by phone in 60 seconds"
    CTA: tap-to-call + “Request a callback” form

OBSERVABILITY
- Every response includes correlationId (displayable in admin/debug UI).
- Add a lightweight admin page or log viewer route (protected) for action logs.

DELIVERABLES FOR THIS SECTION
- `actionSchemas.ts` (Zod schemas + action union)
- `mcpClient.ts` (server-side MCP tool invocation)
- `/api/actions/dispatch.ts` (server endpoint)
- `dispatchCardAction.ts` (client)
- `serviceMapping.ts` (server-side mapping helper)
- One complete E2E path:
  service_recommendation card -> BOOK NOW -> MCP tool call -> booking created -> booking_confirmation card returned and rendered