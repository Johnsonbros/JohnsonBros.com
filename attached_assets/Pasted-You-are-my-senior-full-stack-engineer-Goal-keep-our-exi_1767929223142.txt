You are my senior full-stack engineer. Goal: keep our existing ChatKit chat UI intact, but implement “dynamic cards” on top of the system (rendered by OUR app, not by ChatKit). ChatKit should continue to display normal chat messages; our app should detect structured “card intents” in assistant responses and render rich React cards either (A) in a right-side panel on desktop and (B) in a bottom “Recommended” drawer on mobile. We also need the same card intents to work for SMS + voice later (they won’t render cards; they’ll get links + summaries). Build this in a clean, scalable way.

CONSTRAINTS
- Do NOT fork/replace ChatKit. Keep current ChatKitWidget and message rendering for normal text.
- Do NOT rely on ChatKit supporting cards; it doesn’t.
- Cards must be rendered by our React app based on structured data from the assistant.
- The assistant must be guided to output a predictable JSON payload when a card is appropriate.
- Must support streaming responses (partial tokens) without breaking.
- Must be secure: never trust model-provided HTML; only render from our own whitelisted schema.
- Our branding: blue/white/silver with optional red accents; professional/realistic “almost cartoon” style (UI not images).

HIGH-LEVEL APPROACH
1) Introduce a “Card Intent Protocol”:
   - The assistant can include a JSON block describing a UI card.
   - The client extracts + validates this JSON against a Zod schema.
   - If valid, store it in a “card state” store and render React components.
   - ChatKit still shows the plain conversational text (and optionally a short “I’ve added a recommendation card” line).

2) Card rendering surfaces:
   - Desktop ≥ 1024px: show a RightSidePanel next to ChatKit with a list/stack of cards.
   - Mobile < 1024px: show a BottomDrawer “Recommended” that opens when new cards arrive.

3) Card lifecycle:
   - Each card has: id (uuid), type, title, summary, priority, createdAt.
   - Cards can be updated: if assistant sends same id, patch/replace.
   - Cards can be dismissed by user.
   - Keep cards scoped to the same chat “thread id”.

4) Supported card types (V1):
   - service_recommendation
   - estimate_range
   - booking_cta
   - membership_plan
   - troubleshooting_steps
   - faq
   Include room for future: product_feed_item, financing_offer.

IMPLEMENTATION TASKS (DO THESE)
A) Define the schema + parser
- Create `cardProtocol.ts`:
  - Export a Zod schema for CardIntent.
  - Typescript types for each card type.
  - Parser function `extractCardIntents(text: string): {cleanText: string, cards: CardIntent[]}`
    - The assistant may include JSON inside triple backticks with a tag like ```card_intent
    - Or inside a sentinel wrapper:
      <CARD_INTENT>{...json...}</CARD_INTENT>
    - Parser should:
      - Find all occurrences
      - JSON.parse safely
      - Validate with Zod (drop invalid)
      - Return cleanText with those blocks removed so chat stays readable.

B) Store & UI layer
- Use Zustand (or existing state lib) to create `useCardStore`:
  - state: cardsByThreadId: Record<string, CardIntent[]>
  - actions: addCards(threadId, cards), updateCard(threadId, card), dismissCard(threadId, cardId), clearThread(threadId)
- Build components:
  - `CardSurface` wrapper that decides desktop panel vs mobile drawer
  - `CardRenderer` that switches on card.type and renders a React card component for each type
  - Individual card components styled to our brand

C) Wire into ChatKit without breaking it
- In `ChatKitWidget` (or wherever messages are received/streamed), intercept assistant messages AFTER they are finalized:
  - When assistant message arrives, run `extractCardIntents(messageText)`
  - Push any cards to `useCardStore.addCards(activeThreadId, cards)`
  - Replace the displayed message text with `cleanText` (so the JSON doesn’t show)
- Streaming: don’t parse until message is “complete”. If ChatKit gives deltas:
  - keep accumulating text
  - parse on completion event or when a delimiter closes.
  - If no completion event exists, parse when the message stops updating for 500ms (debounce) AND JSON block is syntactically closed.

D) Assistant instruction / system prompt changes
- Update the assistant prompt to:
  - ALWAYS respond normally in plain English.
  - ONLY include card intents when helpful.
  - When including a card intent, put it in:
    ```card_intent
    { ...valid JSON matching schema... }
    ```
  - Never include user-provided HTML.
  - Keep card summaries short and actionable.

E) Example card intents (must work end-to-end)
Provide at least 3 examples and ensure the renderer supports them:

1) service_recommendation:
```card_intent
{
  "id":"<uuid>",
  "type":"service_recommendation",
  "title":"Main Line Drain Clearing",
  "summary":"Recommended based on symptoms: recurring backups, slow drains, gurgling.",
  "priceRange":{"min":249,"max":649,"currency":"USD"},
  "priority":"high",
  "cta":{"label":"Book Now","action":"BOOKING_FLOW","payload":{"serviceId":"main_line_clearing"}}
}