You are my senior TypeScript/React engineer. We already implemented a Card Intent Protocol using Zod schemas + `extractCardIntents()` + `isCardIntentComplete()`. I’m pasting the current code below (assume it exists exactly as shown). Your job is to fix the issues and harden it for real-world usage (streaming, users pasting code blocks, multiple card intents, server/client runtime differences). Make ONLY the necessary changes, keep existing behavior, and add tests.

PRIMARY ISSUES TO FIX
1) `isCardIntentComplete()` is unreliable:
   - It currently counts closing ``` fences using /```(?!card_intent)/g which incorrectly counts other fenced blocks (```json, ```ts, etc.).
   - It must correctly detect whether all ` ```card_intent ... ``` ` blocks are closed AND all `<CARD_INTENT>...</CARD_INTENT>` tags are balanced, without being confused by other triple-backtick blocks.

2) `extractCardIntents()` regex exec uses the original `text` while mutating `cleanText`:
   - This can desync with multiple blocks / repeated substrings.
   - Change it so extraction runs against the same string being modified (i.e., `cleanText`), with safe resetting of regex lastIndex.

3) CTA action must be locked down:
   - Replace `cta.action: z.string()` with a strict enum of allowed actions (real actions that will be dispatched through our `/api/actions/dispatch` endpoint which calls our MCP server).
   - Use a new `CardActionEnum` and update any schemas that reference `cta.action`.

4) Normalize date formats:
   - Introduce reusable Zod validators:
     - DateOnly: YYYY-MM-DD
     - TimeHM: HH:mm
     - DateTimeISO: ISO datetime (existing .datetime is fine, but ensure usage is consistent)
   - Apply to:
     - DatePickerCard.availableDates[].date
     - DatePickerCard.selectedDate
     - TimePickerCard.selectedDate
     - BookingConfirmationCard.booking.scheduledDate
     - BookingConfirmationCard.booking.scheduledTime
   - Keep backward compatibility if you can (e.g., accept ISO and YYYY-MM-DD for a transition), but prefer enforcing date-only for picker/booking fields.

5) UUID generation portability:
   - `crypto.randomUUID()` may not exist in all runtimes (SSR/Node/edge).
   - Implement a small helper `safeRandomUUID()` that works in browser + Node (use node:crypto randomUUID fallback).
   - Use this helper wherever we generate ids.

6) Add versioning now (future-proof):
   - Add `version: "1"` to BaseCardSchema with default.

DELIVERABLES
A) Update the schema file (the one containing all card schemas + extract functions):
   - Implement the fixes above.
   - Keep exported names the same unless absolutely necessary.
   - Add `CardActionEnum` export.
   - Add helper exports: `safeRandomUUID`, `DateOnly`, `TimeHM` if useful.

B) Add tests (Vitest or Jest depending on repo; pick whatever is already installed):
   - Tests for `extractCardIntents`:
     - Extracts one valid ```card_intent block and removes it from cleanText.
     - Extracts multiple blocks (mix of ```card_intent and <CARD_INTENT>) and returns multiple cards.
     - Ignores invalid JSON and records errors.
     - Ignores invalid schema and records errors.
     - Does NOT break when the message contains other code fences (```ts, ```json).
   - Tests for `isCardIntentComplete`:
     - Returns false when ```card_intent opener exists without closing ```.
     - Returns true when properly closed.
     - Returns false when <CARD_INTENT> is unbalanced.
     - Returns true when other fenced blocks exist (```ts ... ```) and card blocks are complete.

C) Ensure extraction is safe:
   - Never execute HTML.
   - Never accept arbitrary CTA actions beyond the enum.
   - Validate everything with Zod.

IMPLEMENTATION NOTES (DO THIS)
- For `isCardIntentComplete`:
  - Do NOT count generic ``` fences.
  - Instead, scan for each ```card_intent opener and verify a subsequent closing ``` exists after it.
  - Also check tag open/close counts for CARD_INTENT tags.

- For `extractCardIntents`:
  - Run regex.exec against `cleanText` (the string you mutate).
  - Because you mutate the string, reset regex.lastIndex appropriately to avoid skipping matches.
  - Ensure regex instances don’t share state across calls (reset to 0 at function start).

- For CTA action enum:
  - Use these initial values (can add more if needed, but no arbitrary strings):
    - "HCP_LOOKUP_CUSTOMER"
    - "HCP_GET_AVAILABILITY"
    - "HCP_CREATE_BOOKING"
    - "HCP_CREATE_ESTIMATE_REQUEST"
    - "OPEN_BOOKING_MODAL"
    - "OPEN_CALL_MODAL"
  - Update all relevant card schemas:
    - BookingConfirmationCardSchema.cta.action
    - ServiceRecommendationCardSchema.cta.action
    - Any other CTAs if present.

- For versioning:
  - `version: z.literal("1").default("1")` on BaseCardSchema.

OUTPUT
- Provide a PR with:
  - updated schema/extractor file
  - new/updated tests
  - brief notes in the PR description about what changed and why

CURRENT CODE (for reference)
[PASTE THE EXISTING CODE HERE EXACTLY AS IT IS]