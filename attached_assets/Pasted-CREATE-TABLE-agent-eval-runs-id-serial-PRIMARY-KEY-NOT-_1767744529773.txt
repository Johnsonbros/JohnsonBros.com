CREATE TABLE "agent_eval_runs" (
	"id" serial PRIMARY KEY NOT NULL,
	"eval_id" integer NOT NULL,
	"run_id" text NOT NULL,
	"passed" boolean NOT NULL,
	"actual_output" text,
	"actual_tool_calls" json,
	"failure_reason" text,
	"latency_ms" integer,
	"model_used" text,
	"prompt_version" text,
	"metadata" json,
	"created_at" timestamp DEFAULT now() NOT NULL
);
CREATE TABLE "agent_evals" (
	"id" serial PRIMARY KEY NOT NULL,
	"eval_id" text NOT NULL,
	"name" text NOT NULL,
	"description" text,
	"category" text NOT NULL,
	"input_messages" json NOT NULL,
	"expected_behavior" text NOT NULL,
	"expected_tool_calls" json,
	"expected_output" text,
	"pass_criteria" json,
	"is_active" boolean DEFAULT true NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp DEFAULT now() NOT NULL,
	CONSTRAINT "agent_evals_eval_id_unique" UNIQUE("eval_id")
);
CREATE TABLE "agent_conversations" (
	"id" serial PRIMARY KEY NOT NULL,
	"session_id" text NOT NULL,
	"channel" text DEFAULT 'web_chat' NOT NULL,
	"customer_phone" text,
	"customer_id" integer,
	"system_prompt" text,
	"messages" json DEFAULT '[]'::json,
	"total_tokens" integer DEFAULT 0,
	"total_tool_calls" integer DEFAULT 0,
	"outcome" text,
	"started_at" timestamp DEFAULT now() NOT NULL,
	"ended_at" timestamp,
	"metadata" json,
	CONSTRAINT "agent_conversations_session_id_unique" UNIQUE("session_id")
);
CREATE TABLE "agent_feedback" (
	"id" serial PRIMARY KEY NOT NULL,
	"conversation_id" integer NOT NULL,
	"tool_call_id" integer,
	"message_index" integer,
	"feedback_type" text NOT NULL,
	"rating" integer,
	"original_response" text,
	"corrected_response" text,
	"flag_reason" text,
	"annotation" text,
	"reviewed_by" text,
	"reviewed_at" timestamp,
	"included_in_training" boolean DEFAULT false,
	"created_at" timestamp DEFAULT now() NOT NULL
);
CREATE TABLE "agent_tool_calls" (
	"id" serial PRIMARY KEY NOT NULL,
	"conversation_id" integer NOT NULL,
	"tool_name" text NOT NULL,
	"tool_call_id" text NOT NULL,
	"arguments" json,
	"result" json,
	"success" boolean DEFAULT true NOT NULL,
	"error_message" text,
	"latency_ms" integer,
	"tokens_before" integer,
	"user_message_trigger" text,
	"was_correct_tool" boolean,
	"correct_tool_suggestion" text,
	"created_at" timestamp DEFAULT now() NOT NULL
);
CREATE TABLE "leads" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"phone" text NOT NULL,
	"email" text,
	"unit_number" text,
	"service_type" text,
	"message" text,
	"campaign_source" text,
	"campaign_medium" text,
	"campaign_name" text,
	"landing_page" text,
	"gclid" text,
	"utm_source" text,
	"utm_medium" text,
	"utm_campaign" text,
	"utm_term" text,
	"utm_content" text,
	"referrer" text,
	"status" text DEFAULT 'new' NOT NULL,
	"converted_customer_id" integer,
	"created_at" timestamp DEFAULT now() NOT NULL
);
ALTER TABLE "agent_eval_runs" ADD CONSTRAINT "agent_eval_runs_eval_id_agent_evals_id_fk" FOREIGN KEY ("eval_id") REFERENCES "public"."agent_evals"("id") ON DELETE no action ON UPDATE no action;
ALTER TABLE "agent_conversations" ADD CONSTRAINT "agent_conversations_customer_id_customers_id_fk" FOREIGN KEY ("customer_id") REFERENCES "public"."customers"("id") ON DELETE no action ON UPDATE no action;
ALTER TABLE "agent_feedback" ADD CONSTRAINT "agent_feedback_conversation_id_agent_conversations_id_fk" FOREIGN KEY ("conversation_id") REFERENCES "public"."agent_conversations"("id") ON DELETE no action ON UPDATE no action;
ALTER TABLE "agent_feedback" ADD CONSTRAINT "agent_feedback_tool_call_id_agent_tool_calls_id_fk" FOREIGN KEY ("tool_call_id") REFERENCES "public"."agent_tool_calls"("id") ON DELETE no action ON UPDATE no action;
ALTER TABLE "agent_tool_calls" ADD CONSTRAINT "agent_tool_calls_conversation_id_agent_conversations_id_fk" FOREIGN KEY ("conversation_id") REFERENCES "public"."agent_conversations"("id") ON DELETE no action ON UPDATE no action;
ALTER TABLE "leads" ADD CONSTRAINT "leads_converted_customer_id_customers_id_fk" FOREIGN KEY ("converted_customer_id") REFERENCES "public"."customers"("id") ON DELETE no action ON UPDATE no action;
CREATE INDEX "eval_run_created_idx" ON "agent_eval_runs" USING btree ("created_at");
CREATE INDEX "eval_run_eval_idx" ON "agent_eval_runs" USING btree ("eval_id");
CREATE INDEX "eval_run_id_idx" ON "agent_eval_runs" USING btree ("run_id");
CREATE INDEX "eval_run_passed_idx" ON "agent_eval_runs" USING btree ("passed");
CREATE INDEX "eval_category_idx" ON "agent_evals" USING btree ("category");
CREATE UNIQUE INDEX "eval_id_idx" ON "agent_evals" USING btree ("eval_id");
CREATE INDEX "agent_conv_channel_idx" ON "agent_conversations" USING btree ("channel");
CREATE INDEX "agent_conv_customer_idx" ON "agent_conversations" USING btree ("customer_id");
CREATE INDEX "agent_conv_outcome_idx" ON "agent_conversations" USING btree ("outcome");
CREATE UNIQUE INDEX "agent_conv_session_idx" ON "agent_conversations" USING btree ("session_id");
CREATE INDEX "agent_conv_started_idx" ON "agent_conversations" USING btree ("started_at");
CREATE INDEX "feedback_conv_idx" ON "agent_feedback" USING btree ("conversation_id");
CREATE INDEX "feedback_included_idx" ON "agent_feedback" USING btree ("included_in_training");
CREATE INDEX "feedback_rating_idx" ON "agent_feedback" USING btree ("rating");
CREATE INDEX "feedback_type_idx" ON "agent_feedback" USING btree ("feedback_type");
CREATE INDEX "tool_call_conv_idx" ON "agent_tool_calls" USING btree ("conversation_id");
CREATE INDEX "tool_call_created_idx" ON "agent_tool_calls" USING btree ("created_at");
CREATE INDEX "tool_call_name_idx" ON "agent_tool_calls" USING btree ("tool_name");
CREATE INDEX "tool_call_success_idx" ON "agent_tool_calls" USING btree ("success");
CREATE INDEX "lead_campaign_idx" ON "leads" USING btree ("campaign_name");
CREATE INDEX "lead_created_at_idx" ON "leads" USING btree ("created_at");
CREATE INDEX "lead_email_idx" ON "leads" USING btree ("email");
CREATE INDEX "lead_landing_page_idx" ON "leads" USING btree ("landing_page");
CREATE INDEX "lead_phone_idx" ON "leads" USING btree ("phone");
CREATE INDEX "lead_status_idx" ON "leads" USING btree ("status");